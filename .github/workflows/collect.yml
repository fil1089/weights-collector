name: Collect Weights IDs

on:
  schedule:
    - cron: '0 */6 * * *'
  
  workflow_dispatch:
    inputs:
      max_time_minutes:
        description: '–¢–∞–π–º–µ—Ä (–º–∏–Ω—É—Ç—ã)'
        required: false
        default: '30'
        type: choice
        options:
          - '5'
          - '10'
          - '15'
          - '30'
          - '60'
          - '120'
      
      scroll_delay:
        description: '–ó–∞–¥–µ—Ä–∂–∫–∞ —Å–∫—Ä–æ–ª–ª–∞ (—Å–µ–∫—É–Ω–¥—ã)'
        required: false
        default: '3'
        type: choice
        options:
          - '1'
          - '2'
          - '3'
          - '5'

env:
  DEFAULT_MAX_TIME: '30'
  DEFAULT_SCROLL_DELAY: '3'

jobs:
  collect:
    runs-on: ubuntu-latest
    timeout-minutes: 150
    
    steps:
    - name: üì• Checkout
      uses: actions/checkout@v4
    
    - name: üêç Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        cache: 'pip'
    
    - name: üåê Setup Chrome
      run: |
        sudo apt-get update
        sudo apt-get install -y chromium-browser chromium-chromedriver
        chromedriver --version
    
    - name: üì¶ Install Python packages
      run: pip install -r requirements.txt
    
    - name: üöÄ Run collector
      env:
        MAX_TIME_MINUTES: ${{ github.event.inputs.max_time_minutes || env.DEFAULT_MAX_TIME }}
        SCROLL_DELAY: ${{ github.event.inputs.scroll_delay || env.DEFAULT_SCROLL_DELAY }}
      run: python collector.py
    
    - name: üìä Stats
      run: |
        if [ -f results/latest_ids.txt ]; then
          echo "‚úÖ –í—Å–µ–≥–æ ID: $(wc -l < results/latest_ids.txt)"
          echo "üì¶ –†–∞–∑–º–µ—Ä: $(du -h results/latest_ids.txt | cut -f1)"
        else
          echo "‚ö†Ô∏è –§–∞–π–ª results –Ω–µ –Ω–∞–π–¥–µ–Ω"
        fi
    
    - name: üì§ Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: weights-results-${{ github.run_number }}
        path: results/
        retention-days: 90
    
    - name: üíæ Commit results
      run: |
        git config user.name "GitHub Actions"
        git config user.email "actions@github.com"
        git add results/ || true
        git diff --quiet && git diff --staged --quiet || \
          git commit -m "ü§ñ Auto: $(date '+%Y-%m-%d %H:%M') | IDs: $(wc -l < results/latest_ids.txt 2>/dev/null || echo 0)"
        git push || echo "Nothing to push"
